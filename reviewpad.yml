extends:
  - https://github.com/trailblazing-reviewpad/.github/blob/main/reviewpad.yml

dictionaries:
 - name: team-per-filepattern
   spec:
     '**/authentication/**': '"security"'
     '**/db/**': '"dba"'
     '.github/workflows/**': '"devops"' 

workflows:
  - name: Assign senior reviewers
    run:
      - forEach:
          key: $teamName
          value: $teamMembers
          in: $dictionary("teams")
          do:
            - if: $isElementOf($author(), $teamMembers)
              then: 
                forEach:
                  key: $teamNameInner
                  value: $seniorMembers
                  in: $dictionary("seniors-per-team")
                  do:
                    if: $teamName == $teamNameInner
                    then: $assignReviewer($seniorMembers)
      - if: $length($group("reviewers")) == 0
        then:
          - $error("No reviewer was assigned")
          - $failCheckStatus("No reviewer was assigned")

  - name: Add block merge label
    run:
      - if: $size() > 10
        then: $addLabel("do-not-merge")

  - name: Block merge on labelling
    run:
      - if: $isElementOf("do-not-merge", $labels())
        then: $failCheckStatus("Do not merge")

  # - name: Approval Policy
  #   run:
  #     - forEach: 
  #         key: $filePattern
  #         value: $teamName
  #         in: $dictionary("team-per-filepattern")
  #         do:
  #           - if: $hasFilePattern($filePattern) && !$hasRequiredApprovals(1, $team($teamName))
  #             then: 
  #               - $failCheckStatus($sprintf("One approval is required from team '%s' as one file matching '%s' has been touched", [$teamName, $filePattern]))
  #               - if: '!$any($reviewers(), ($reviewer: String => $isElementOf($reviewer, $team($teamName))))'
  #                 then: $assignTeamReviewer([$teamName])
