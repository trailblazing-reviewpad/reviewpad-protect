extends:
  - https://github.com/trailblazing-reviewpad/.github/blob/main/reviewpad.yml

dictionaries:
 - name: team-per-filepattern
   spec:
     '**/authentication/**': '"security"'
     '**/db/**': '"dba"'
     '.github/workflows/**': '"devops"' 

workflows:
  - name: Approval Policy
    run:
      - forEach: 
          key: $filePattern
          value: $teamName
          in: $dictionary("team-per-filepattern")
          do:
            - if: $hasFilePattern($filePattern)
              then:
                if: '$all($group("reviewers"), ($r: String => $reviewerStatus($r) == "APPROVED"))'
                then:
                  if: '!$hasRequiredApprovals(1, $team($teamName))'
                  then: $assignTeamReviewer([$teamName])

  - name: Block merge if there are no reviewers
    run:
      - if: $length($group("reviewers")) == 0
        then:
          - $error("No reviewer was assigned")
          - $failCheckStatus("No reviewer was assigned")

  - name: Block merge if there are missing approvals
    run:
      - if: '$any($group("reviewers"), ($r: String => $reviewerStatus($r) != "APPROVED"))'
        then:
          - $error("Missing approvals")
          - $failCheckStatus("Missing approvals")
