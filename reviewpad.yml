extends:
  - https://github.com/trailblazing-reviewpad/.github/blob/main/reviewpad.yml

dictionaries:
 - name: team-per-filepattern
   spec:
     '**/auth/**': '"security"'
     '**/db/**': '"dba"'
     '.github/workflows/**': '"devops"'

workflows:
  - name: Required final approval based on changes
    run:
      - if: $rule("all-reviewers-approved")
        then:
          forEach:
            key: $filePattern
            value: $teamName
            in: $dictionary("team-per-filepattern")
            do:
              if: $hasFilePattern($filePattern) && !$hasRequiredApprovals(1, $team($teamName))
              then: $assignReviewer($team($teamName), 1)

  - name: Block merge criteria
    run:
      - if: $rule("has-reviewers") == false
        then:
          - $error("No reviewer was assigned")
          - $failCheckStatus("No reviewer was assigned")

      - if: $rule("all-reviewers-approved") == false
        then:
          - $error("Missing approvals")
          - $failCheckStatus("Missing approvals")
